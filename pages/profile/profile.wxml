<view class="container">
  <view wx:if="{{loading}}" class="card state-card">加载中...</view>
  <view wx:if="{{!loading && errorText}}" class="card state-card">
    <view class="error-text">{{errorText}}</view>
    <button size="mini" class="btn-light" bindtap="reload">重试</button>
  </view>
  <view wx:if="{{!loading && !errorText}}">
  <view class="card">
    <view class="section-title">我的账号</view>
    <view class="me-row">
      <open-data class="avatar" type="userAvatarUrl"></open-data>
      <view class="me-meta">
        <open-data class="nick" type="userNickName"></open-data>
        <view class="subtle">当前身份：{{familyData && familyData.isSuperAdmin ? "超级管理员" : (familyData && familyData.myRole ? familyData.myRole : "成员")}}</view>
      </view>
    </view>
    <input class="input" data-f="editNickname" value="{{editNickname}}" bindinput="onInput" placeholder="昵称" />
    <input class="input" data-f="editPhone" value="{{editPhone}}" bindinput="onInput" placeholder="手机号（11位）" type="number" />
    <button class="btn-primary" bindtap="saveProfile" disabled="{{busy}}">保存资料</button>
    <view class="meta">所属家庭：{{familyData && familyData.family ? familyData.family.name : "未加入家庭"}}</view>
    <button class="btn-light" bindtap="goFamily">家庭管理</button>
  </view>
  <view class="card">
    <view class="section-title">家庭与身份切换</view>
    <view wx:if="{{!memberships.length}}" class="subtle">当前未加入任何家庭</view>
    <view wx:for="{{memberships}}" wx:key="familyId" class="switch-row">
      <view>{{item.familyName}}（{{item.familyRole}}）</view>
      <button
        size="mini"
        class="btn-light"
        data-family-id="{{item.familyId}}"
        bindtap="switchFamily"
        disabled="{{busy || activeFamilyId === item.familyId}}"
      >{{activeFamilyId === item.familyId ? "当前" : "切换"}}</button>
    </view>
  </view>
  <view wx:if="{{familyData.isSuperAdmin}}" class="card">
    <view class="section-title">全部家庭（超级管理员）</view>
    <view wx:for="{{familyData.families}}" wx:key="id" class="all-family-item">
      <view>{{item.name}}（成员 {{item.members.length}}）</view>
      <view class="subtle" wx:for="{{item.members}}" wx:key="id">{{item.name}} · {{item.familyRole}}</view>
    </view>
  </view>
  <view class="card">
    <view class="section-title">账号</view>
    <button class="btn-light" bindtap="logout" disabled="{{busy}}">退出登录</button>
  </view>
  </view>
</view>
